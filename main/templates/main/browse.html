{% extends "main/layout.html" %}
{% load static %}

{% block head %}
    <script src='{% static 'handlebars-v4.0.12.js' %}'></script>
    <script id="filter-selected-template" type="text/x-handlebars-template">
        {% verbatim %}
        <div class='filter-selected'>
            {{filter_name}}
            <span class="remove-filter" data-type='{{filter_type}}' onclick='removeFilter(event)'>&times
        </div>
        {% endverbatim %}
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var source = document.getElementById('filter-selected-template').innerHTML;
            var template = Handlebars.compile(source);

            category_id = getAllUrlParams().category;
            func_id = getAllUrlParams().func;
            active_category = document.querySelector(`#category-container button[data-id='${category_id}']`);
            active_func = document.querySelector(`#func-container button[data-id='${func_id}']`);

            if (window.active_category) {
                active_category.className += ' active';
                var context = {filter_name: active_category.innerHTML, filter_type: 'category'};
                var html = template(context);
                document.getElementById('filters-selected').innerHTML += html;
            }
            if (window.active_func) {
                active_func.className += ' active';
                var context = {filter_name: active_func.innerHTML, filter_type: 'func'};
                var html = template(context);
                document.getElementById('filters-selected').innerHTML += html;
            }
        });

        function getAllUrlParams(url) {

          // get query string from url (optional) or window
          var queryString = url ? url.split('?')[1] : window.location.search.slice(1);

          // we'll store the parameters here
          var obj = {};

          // if query string exists
          if (queryString) {

            // stuff after # is not part of query string, so get rid of it
            queryString = queryString.split('#')[0];

            // split our query string into its component parts
            var arr = queryString.split('&');

            for (var i=0; i<arr.length; i++) {
              // separate the keys and the values
              var a = arr[i].split('=');

              // in case params look like: list[]=thing1&list[]=thing2
              var paramNum = undefined;
              var paramName = a[0].replace(/\[\d*\]/, function(v) {
                paramNum = v.slice(1,-1);
                return '';
              });

              // set parameter value (use 'true' if empty)
              var paramValue = typeof(a[1])==='undefined' ? true : a[1];

              // (optional) keep case consistent
              paramName = paramName.toLowerCase();
              paramValue = paramValue.toLowerCase();

              // if parameter name already exists
              if (obj[paramName]) {
                // convert value to array (if still string)
                if (typeof obj[paramName] === 'string') {
                  obj[paramName] = [obj[paramName]];
                }
                // if no array index number specified...
                if (typeof paramNum === 'undefined') {
                  // put the value on the end of the array
                  obj[paramName].push(paramValue);
                }
                // if array index number specified...
                else {
                  // put the value at that index number
                  obj[paramName][paramNum] = paramValue;
                }
              }
              // if param name doesn't exist yet, set it
              else {
                obj[paramName] = paramValue;
              }
            }
          }

          return obj;
        }

        function selectCategory(evt, category) {
            // change css classname for active display
            var categoryButtons = document.querySelectorAll('#category-container .filter-button');
            categoryButtons.forEach(button => {
                button.className = button.className.replace(' active', '');
            });
            evt.currentTarget.className += ' active';

            // get request parameters
            params = getAllUrlParams();
            params['category'] = category;
            applyFilters(params);
        }

        function selectFunc(evt, func) {
            // change css classname for active display
            var funcButtons = document.querySelectorAll('#func-container .filter-button');
            funcButtons.forEach(button => {
                button.className = button.className.replace(' active', '');
            });
            evt.currentTarget.className += ' active';

            // get request parameters
            params = getAllUrlParams();
            params['func'] = func;
            applyFilters(params);
        }

        function applyFilters(params) {
            queryString = "?" + Object.keys(params).map(function(key){
                return key+"="+params[key]
            }).join("&");

            location.href = window.location.origin + window.location.pathname + queryString;
        }

        function removeFilter(evt) {
            evt.currentTarget.parentElement.style.display='none';
            params = getAllUrlParams();
            if (evt.currentTarget.dataset.type === 'category') {
                delete params['category'];
            }
            else if (evt.currentTarget.dataset.type === 'func') {
                delete params['func'];
            }
            applyFilters(params);
        }

    </script>
{% endblock %}

{% block header %}
    <form action="{% url 'search' %}" class="search" method="get">
        <input name="title_search" type="text" placeholder="Title Search">
        <button>Search</button>
    </form>

    <a href='{% url 'upload' %}' style='color:#6abad1'>Upload a video</a>
    <a href='{% url 'account' %}' style='font-weight:bold; color:#6abad1'>My Account</a>
    {{ user.username }}
    {{ group.name }}
    <a href='{% url 'logout' %}'>Sign out</a>
{% endblock %}

{% block content %}
    <div id="filter-container">
        <form action='{% url 'index' %}' method='get' class="search">
            <input name="location_search" type="text" placeholder="Los Angeles, CA">
            <button>Search</button>
        </form>

        <div id="category-container">
            <button class="filter-button" data-id=1 onclick="selectCategory(event, 1)">Category 1</button>
            <button class="filter-button" data-id=2 onclick="selectCategory(event, 2)">Category 2</button>
            <button class="filter-button" data-id=3 onclick="selectCategory(event, 3)">Category 3</button>
        </div>

        <div id="func-container">
            <button class="filter-button" data-id=1 onclick="selectFunc(event, 1)">Function 1</button>
            <button class="filter-button" data-id=2 onclick="selectFunc(event, 2)">Function 2</button>
            <button class="filter-button" data-id=3 onclick="selectFunc(event, 3)">Function 3</button>
        </div>
    </div>

    <div id="main">
        <div id='filters-selected' style='padding:5px'>
            Filters selected:
        </div>

        {% block main %}
        {% endblock %}

        <div class="video-grid">
            {% for video in videos %}
                <div class='video-item'>
                    <div class='thumbnail'>
                        <a class='thumbnail' href='{% url 'watch' video.id %}'>
                            <img src='{% static 'main/thumbnail.png' %}'>
                        </a>
                    </div>
                    <a href='{% url 'watch' video.id %}'>{{ video.title }}</a>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}
